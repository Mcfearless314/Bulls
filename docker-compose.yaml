services:
  apigateway:
    image: apigateway
    build:
      context: .
      dockerfile: ApiGateway/Dockerfile
    env_file:
      - .env # See .env.example for reference.
    ports:
      - "5000:8080"
    networks:
      - default
      - microservices

  # Unseal manually after starting so it can be used
  vault:
    image: hashicorp/vault
    container_name: bulls-vault
    cap_add:
      - IPC_LOCK
    volumes:
      - ./config.hcl:/vault/config/config.hcl:ro
      - ./vault_data:/vault/data
    ports:
      - "8200:8200"
    command: server
    networks:
      - default
      - microservices
      
  authentication-service-api:
    image: authentication-service-api
    build:
      context: .
      dockerfile: AuthenticationMicroservice/AuthenticationService.Api/Dockerfile
    networks:
      - microservices
      
  stock-service:
    image: stockservice
    build:
      context: .
      dockerfile: StockMicroservice/StockService.Api/Dockerfile
    ports:
      - "5001:8080"
    depends_on:
      apigateway:
        condition: service_started
      stock-db:
        condition: service_started
    networks:
      - default 
      - microservices
        
  stock-db:
    image: mcr.microsoft.com/azure-sql-edge:latest
    environment:
      MSSQL_SA_PASSWORD: "SuperSecret7!"
      ACCEPT_EULA: "Y"
    volumes:
      - stock-data:/var/opt/mssql
    networks:
      - microservices
         
  order-service:
    image: orderservice
    build:
      context: .
      dockerfile: OrderMicroservice/OrderService.Api/Dockerfile
    ports:
      - "5002:8080"
    depends_on:
      apigateway:
        condition: service_started
      order-db:
        condition: service_started
    networks:
      - default
      - microservices

  order-db:
    image: mcr.microsoft.com/azure-sql-edge:latest
    environment:
      MSSQL_SA_PASSWORD: "SuperSecret7!"
      ACCEPT_EULA: "Y"
    volumes:
      - order-data:/var/opt/mssql
    networks:
      - microservices
      
      
networks:
  microservices:
    internal: true

volumes:
  stock-data:
  order-data: