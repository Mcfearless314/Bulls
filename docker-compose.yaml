services:
  apigateway:
    image: apigateway
    build:
      context: .
      dockerfile: ApiGateway/Dockerfile
    env_file:
      - .env # See .env.example for reference.
    ports:
      - "5000:8080"
    networks:
      - default
      - microservices

  vault:
    image: hashicorp/vault
    container_name: bulls-vault
    ports: 
      - "8200:8200"
    cap_add:
      - IPC_LOCK
    volumes:
      - ./config.hcl:/vault/config/config.hcl:ro
      - ./vault_data:/vault/data
    command: server
    networks:
      - default
      - microservices
      
  authentication-service-api:
    image: authentication-service-api
    build:
      context: .
      dockerfile: AuthenticationMicroservice/AuthenticationService.Api/Dockerfile
    env_file:
      - .env
    depends_on:
      apigateway:
        condition: service_started
      authentication-db:
        condition: service_healthy
    networks:
      - microservices
  
  authentication-db:
    image: mcr.microsoft.com/azure-sql-edge:latest
    environment:
      MSSQL_SA_PASSWORD: ${MSSQL_SA_PASSWORD}
      ACCEPT_EULA: "Y"
    volumes:
      - authentication-data:/var/opt/mssql
    networks:
      - microservices
    healthcheck:
      test: [ "CMD-SHELL", "/opt/mssql-tools/bin/sqlcmd -S localhost -U sa -P \"$MSSQL_SA_PASSWORD\" -Q \"SELECT 1\" > /dev/null || exit 1" ]
      interval: 5s
      timeout: 10s
      retries: 5
      start_period: 30s
        
  stock-service:
    image: stockservice
    build:
      context: .
      dockerfile: StockMicroservice/StockService.Api/Dockerfile
    env_file:
      - .env
    depends_on:
      apigateway:
        condition: service_started
      rmq:
        condition: service_healthy
      stock-db:
        condition: service_started
    networks:
      - microservices
      - default
        
  stock-db:
    image: mcr.microsoft.com/mssql/server:2022-latest
    environment:
      MSSQL_SA_PASSWORD: ${MSSQL_SA_PASSWORD}
      MSSQL_AGENT_ENABLED: "true"
      ACCEPT_EULA: "Y"
    env_file:
      - .env
    ports:
      - "1433:1433"
    volumes:
      - stock-data:/var/opt/mssql
    networks:
      - microservices
      - default
         
  order-service:
    image: orderservice
    build:
      context: .
      dockerfile: OrderMicroservice/OrderService.Api/Dockerfile
    env_file:
      - .env
    depends_on:
      apigateway:
        condition: service_started
      rmq:
        condition: service_healthy
      order-db:
        condition: service_started
    networks:
      - microservices

  order-db:
    image: mcr.microsoft.com/azure-sql-edge:latest
    environment:
      MSSQL_SA_PASSWORD: ${MSSQL_SA_PASSWORD}
      ACCEPT_EULA: "Y"
    env_file:
      - .env
    volumes:
      - order-data:/var/opt/mssql
    networks:
      - microservices
   
  payment-service:
    image: paymentservice
    build:
      context: .
      dockerfile: PaymentMicroservice/PaymentService.Api/Dockerfile
    env_file:
      - .env
    depends_on:
      apigateway:
        condition: service_started
      rmq:
        condition: service_healthy
      payment-db:
        condition: service_started
    networks:
      - microservices

  payment-db:
    image: mcr.microsoft.com/azure-sql-edge:latest
    environment:
      MSSQL_SA_PASSWORD: ${MSSQL_SA_PASSWORD}
      ACCEPT_EULA: "Y"
    env_file:
      - .env
    volumes:
      - payment-data:/var/opt/mssql
    networks:
      - microservices
  
  
  order-saga:
    build:
      context: .
      dockerfile: OrchestrationService/OrderSagaService/Dockerfile
    env_file:
      - .env
    depends_on:
      rmq:
        condition: service_healthy
      order-service:
        condition: service_started
      stock-service:
        condition: service_started
      payment-service:
        condition: service_started
    networks:
      - microservices
        
  rmq:
    image: rabbitmq:3-management
    container_name: bulls-rabbitmq
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_DEFAULT_USER}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_DEFAULT_PASS}
    env_file:
      - .env
    healthcheck:
      test: [ "CMD", "rabbitmq-diagnostics", "check_running" ]
      interval: 5s
      timeout: 10s
      retries: 5
    networks:
      - microservices
      
networks:
  microservices:
    internal: true

volumes:
  stock-data:
  order-data:
  payment-data:
  authentication-data: